<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gss.web.common.mapper.CalculateMapper">
	<select id="selectByUserNumber" parameterType="int" resultType="com.gss.web.common.domain.CalculateMain">
		select
			p.partyname, m.charatername
		from 
			partytab as p 
			join memberofpartytab as m
		on
			p.partynum = m.partynum 
			and m.partyleader = true 
			and m.gssusernum = #{userNum};
	</select>
	
	<select id="selectByUserId" parameterType="String" resultType="int">
		select 
			distinct g.gssusernum 
		from 
			gssusertab as g 
			join memberofpartytab as m
		on 
			g.gssuserid  = #{userId};
	</select>
	
	<select id="selectCountMember" parameterType="String" resultType="int">
		select 
			count(*) 
		from 
			partytab as p 
			join memberofpartytab as m
		on 
			p.partynum = m.partynum 
			and p.partyname = #{partyName};
	</select>
	
	<select id="selectPartyLeader" parameterType="String" resultType="com.gss.web.common.domain.Calculate">
		select 
			m.charatername,
			m.divisionpercent
		from 
			partytab as p 
			join memberofpartytab as m
		on 
			p.partynum = m.partynum 
			and p.partyname = #{partyName} 
			and m.partyleader = true;
	</select>
	
	<select id="selectPartyMember" parameterType="String" resultType="com.gss.web.common.domain.Calculate">
		select 
			m.charatername,
			m.divisionpercent 
		from 
			partytab as p 
			join memberofpartytab as m
		on 
			p.partynum = m.partynum 
			and p.partyname = #{partyName} 
			and m.partyleader = false;
	</select>
	
	<select id="selectBossNameAndGrade" parameterType="String" resultType="com.gss.web.common.domain.Calculate">
		select 
			b2.bossname, 
			b2.bossgrade  
		from 
			partytab as p 
			join bosshuntingatpartytab as b 
		on 
			(p.partynum = b.partynum 
			 and p.partyname = #{partyName}) 
			 join bosstab b2 
		on 
			(b.bossnum = b2.bossnum);
	</select>
	
	<select id="selectItemNameAndPrice" parameterType="String" resultType="com.gss.web.common.domain.PartyGetItem">
		select 
			p.pgikey, 
			p.itemsaleprice, 
			i.itemname
		from 
			partygetitemtab as p 
			join partytab p2 
			on (p.partynum = p2.partynum and p2.partyname = #{partyName})
			join itemtab i 
		on 
			p.itemnum = i.itemnum
			and p.resultstat = false;
	</select>
	
	<insert id="insertItemNameAndPrice" parameterType="com.gss.web.api.dto.PartyGetItemDto">
		INSERT INTO 
			partygetitemtab
			(partynum, 
			 resultdate, 
			 itemsaleprice, 
			 resultstat, 
			 itemnum)
		VALUES(
			(SELECT 
					partynum 
			FROM 
					partytab 
			where 
			partyname = #{partyName}
			), 
			now(), 
			#{itemPrice}, 
			false, 
			(SELECT 
				itemnum 
			from 
				itemtab 
			where 
				itemname = #{itemName}
			)
		);
	</insert>
	
	<select id="selectMemberAll" parameterType="String" resultType="com.gss.web.common.domain.Calculate">
		select 
			m.charatername 
		from 
			partytab as p 
			join memberofpartytab as m
		on 
			p.partynum = m.partynum 
			and p.partyname = #{partyName} 
	</select>
	
	<update id="updateMemberOfPricePercent" parameterType="com.gss.web.api.dto.PriceRatioDto">
		update 
			memberofpartytab
		set 
			divisionpercent = #{divisionPercent}
		where 
			partynum = (select partynum from partytab where partyname = #{partyName}) 
			and 
			charatername = #{charaterName};	
	</update>
	
	<update id="updateResultState" parameterType="String">
		update 
			partygetitemtab
		set  
			resultstat = true
		where 
			partynum = (select partynum from partytab where partyname = #{partyName}) 
			and resultstat = false;
	</update>
	
	<select id="selectPartyNum" parameterType="String" resultType="int">
		select 
			partynum
		from
			partytab
		where partyname = #{partyName}
	</select>
	
	<select id="selectMemberOfPartyNum" parameterType="com.gss.web.common.domain.UserRatioInfo" resultType="int">
		select 
			memberofpartynum 
		from 
			memberofpartytab 
		where 
			partynum = #{partyNum}
		 	and gssusernum = #{gssUserNum};
	</select>
	
	<select id="selectPartyGetItemNumber" parameterType="String" resultType="int">
		select 
			pg.pgikey 
		from 
			partygetitemtab as pg 
			join partytab as pt 
		on 
			pg.partynum = pt.partynum 
			and pt.partyname = #{partyName}
	</select>
	
	<select id="selectUserRatioInfo" parameterType="String" resultType="com.gss.web.common.domain.UserRatioInfo">
		select 
			divisionpercent, 
			gssusernum,
			partynum 
		from 
			memberofpartytab 
		where 
			partynum = 
			(select partynum from partytab where partyname = #{partyName});
	</select>
	
	<insert id="insertResultTab" parameterType="com.gss.web.api.dto.ResultTabDto">
		INSERT INTO resulttab
			(gssusernum, 
			memberofpartynum, 
			pgikey, 
			resultdate, 
			partymembercount, 
			resultprice)
		VALUES(#{gssUserNum}, #{memberOfPartyNum}, #{pgiKey}, now(), #{partyMemberCount}, #{resultPrice});
	</insert>
	
	<select id="selectCalculateCompletList" parameterType="String" resultType="com.gss.web.common.domain.CalculateComplete">
		select distinct 
			pa.partyname, 
			me.charatername, 
			re.resultprice, 
			re.resultdate 
		from 
			resulttab as re 
			join gssusertab as gs 
		on 
			gs.gssusernum = re.gssusernum 
			and gs.gssuserid = #{userId} 
			join memberofpartytab as me 
			on 
				me.gssusernum = re.gssusernum 
				join partytab as pa 
				on 
					pa.partynum = me.partynum 
					and me.memberofpartynum = re.memberofpartynum;
	</select>
	
	<select id="selectCalculateCompleteItemList" parameterType="String" resultType="com.gss.web.common.domain.PartyGetItem">
		select 
			p.itemsaleprice, 
			i.itemname
		from 
			partygetitemtab as p 
			join partytab p2 
			on (p.partynum = p2.partynum and p2.partyname = #{partyName})
			join itemtab i 
		on 
			p.itemnum = i.itemnum
			and p.resultstat = true;
	</select>
	
	<select id="selectBossNumByPartyName" parameterType="String" resultType="int">
		select distinct  
			bossnum 
		from
			bosshuntingatpartytab 
		where 
			partynum = 
			(select 
				partynum 
			from 
				partytab
			where
				partyname = #{partyName}); 
	</select>
	
	<select id="selectItemNumByBossNumber" parameterType="int" resultType="int">
		select 
			itemnum 
		from 
			itemofbosstab
		where 
			bossnum = #{bossNum};	
	</select>
	
	<select id="selectItemByItemNumber" parameterType="int" resultType="com.gss.web.common.domain.ItemInfo">
		select itemname, itemimagepath, classification  
		from itemtab as it join itemofbosstab as ib
		on it.itemnum = ib.itemnum and ib.bossnum = #{bossNum};	
	</select>
	
	<delete id="deletePartyGetItem" parameterType="int">
		DELETE 
		FROM 
			partygetitemtab
		WHERE 
			pgikey=#{pgiKey};
	</delete>
</mapper>
